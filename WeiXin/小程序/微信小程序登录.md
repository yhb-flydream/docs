# 微信小程序登录

- [官方文档](https://developers.weixin.qq.com/ebook?action=get_post_info&token=935589521&volumn=1&lang=zh_CN&book=miniprogram&docid=000cc48f96c5989b0086ddc7e56c0a)
- 微信登录的整个过程![微信登录的整个过程](../../images/WX/weixindenglushouquan.png)

## 步骤

### 1、获取微信登录凭证 code

为了避免这样的风险，`wx.login`是生成一个带有时效性的凭证，就像是一个会过期的临时身份证一样，在`wx.login`调用时，会先在微信后台生成一张临时的身份证，其有效时间仅为 5 分钟。然后把这个临时身份证返回给小程序方，这个临时的身份证我们把它称为微信登录凭证 code。如果 5 分钟内小程序的后台不拿着这个临时身份证来微信后台服务器换取微信用户 id 的话，那么这个身份证就会被作废，需要再调用`wx.login`重新生成登录凭证。

### 2、发送 code 到开发者服务器

在`wx.login`的**success 回调中拿到微信登录凭证**，紧接着会通过`wx.request`把`code`传到开发者服务器，为了后续可以换取微信用户身份 id。如果当前微信用户还没有绑定当前小程序业务的用户身份，那在这次请求应该顺便把用户输入的帐号密码一起传到后台，然后开发者服务器就可以校验账号密码之后再和微信用户 id 进行绑定。

```js
Page({
  tapLogin: function () {
    wx.login({
      success: function (res) {
        if (res.code) {
          wx.request({
            url: 'https://test.com/login',
            data: {
              username: 'zhangsan', // 用户输入的账号
              password: 'pwd123456', // 用户输入的密码
              code: res.code,
            },
            success: function (res) {
              // 登录成功
              if (res.statusCode === 200) {
                console.log(res.data.sessionId) // 服务器回包内容
              }
            },
          })
        } else {
          console.log('获取用户登录态失败！' + res.errMsg)
        }
      },
    })
  },
})
```

### 3、到微信服务器换取微信用户身份 id

此时就可以拿这个`code`到微信服务器换取微信用户身份。微信服务器为了确保拿`code`过来换取身份信息的人就是刚刚对应的小程序开发者，到微信服务器的请求要同时带上`AppId`和`AppSecret`，这两个信息在小程序管理平台的开发设置界面可以看到。

`AppId`和`AppSecret`是微信鉴别开发者身份的重要信息，`AppId`是公开信息，泄露`AppId`不会带来安全风险，但是`AppSecret`是开发者的隐私数据不应该泄露，如果发现泄露需要到小程序管理平台进行重置`AppSecret`，而`code`在成功换取一次信息之后也会立即失效，即便凭证`code`生成时间还没过期。

开发者服务器和微信服务器通信也是通过 HTTPS 协议，微信服务器提供的接口地址是：

```txt
https://api.weixin.qq.com/sns/jscode2session?appid=<AppId>&secret=<AppSecret>&js_code=<code>&grant_type=authorization_code
```

- 请求参数

| 字段      | 描述                       |
| --------- | -------------------------- |
| AppId     | 公众号的唯一标识           |
| AppSecret | 开发者密码                 |
| code      | 填写第一步获取的`code`参数 |

- 返回字段

| 字段        | 描述                                                                                                                                                                    |
| ----------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| openid      | 微信用户的唯一标识                                                                                                                                                      |
| session_key | 会话密钥（**微信服务器给开发者服务器颁发的身份凭证，开发者可以用 session_key 请求微信服务器其他接口来获取一些其他信息，session_key 不应该泄露或者下发到小程序前端。**） |
| unionid     | 用户在微信开放平台的唯一标识符。本字段在满足一定条件的情况下才返回。                                                                                                    |

### 4、绑定微信用户身份 id 和业务用户身份

业务侧用户还没绑定微信侧身份时，会让用户填写业务侧的用户名密码，这两个值会和微信登录凭证一起请求开发者服务器的登录接口，此时开发者后台通过校验用户名密码就拿到了业务侧的用户身份 id，通过 code 到微信服务器获取微信侧的用户身份 openid。微信会建议开发者把这两个信息的对应关系存起来，我们把这个对应关系称之为“绑定”。

有了这个绑定信息，小程序在下次需要用户登录的时候就可以不需要输入账号密码，因为通过`wx.login()`获取到 code 之后，可以拿到用户的微信身份 openid，通过绑定信息就可以查出业务侧的用户身份 id，这样静默授权的登录方式显得非常便捷。

### 5、业务登录凭证 SessionId

微信侧返回的`session_key`是开发者服务器和微信服务器的会话密钥，同样道理，开发者服务器和开发者的小程序应该也有会话密钥，在本书中我们就把它称之为`SessionId`。

**用户登录成功之后，开发者服务器需要生成会话密钥`SessionId`**，在服务端保持`SessionId`对应的用户身份信息，同时把`SessionId`返回给小程序。

**小程序后续发起的请求中携带上`SessionId`，开发者服务器就可以通过服务器端的`Session`信息查询到当前登录用户的身份**，这样我们就不需要每次都重新获取 code，省去了很多通信消耗。
